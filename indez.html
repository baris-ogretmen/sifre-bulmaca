<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Şifre Ustası Pro: Sınıf Ligi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: manipulation;
        }

        .title-font { font-family: 'Righteous', cursive; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Kart Çevirme Animasyonu */
        .char-box { perspective: 1000px; }
        .char-inner {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            width: 100%; height: 100%;
        }
        .char-box.revealed .char-inner { transform: rotateY(180deg); }
        .char-front, .char-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex;
            align-items: center; justify-content: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        .char-front { background-color: #334155; border: 2px solid #475569; }
        .char-back { 
            background: linear-gradient(135deg, #2563eb, #7c3aed); 
            transform: rotateY(180deg);
            color: white; font-weight: 900;
            border: 2px solid #60a5fa;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .answer-btn {
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            color: #1e293b;
            border-bottom: 4px solid #cbd5e1;
            transition: all 0.1s;
        }
        .answer-btn:active { transform: translateY(3px); border-bottom-width: 1px; }
        .answer-btn.correct {
            background: #22c55e; color: white; border-color: #15803d;
            pointer-events: none; opacity: 1; border-bottom-width: 0; transform: translateY(4px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .answer-btn.wrong {
            background: #ef4444; color: white; border-color: #b91c1c;
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .confetti { position: fixed; width: 10px; height: 10px; z-index: 100; pointer-events: none; }
        
        /* Z-Index Düzeltmeleri */
        #loginScreen .absolute { z-index: 60; } /* Geri butonu en üstte */
        #gameScreen .glass-panel { z-index: 20; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-0 md:p-4 text-slate-100">

    <!-- 1. YÖNETİM PANELİ (ANA MENÜ) -->
    <div id="categoryScreen" class="w-full max-w-lg text-center p-6 h-full flex flex-col justify-center fade-in z-50">
        <div class="mb-8 relative">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl animate-pulse"></div>
            <h1 class="text-5xl md:text-6xl title-font text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 drop-shadow-lg mb-2">ŞİFRE USTASI</h1>
            <p class="text-slate-400 font-medium tracking-wider text-sm uppercase">Profesyonel Sınıf Ligi</p>
        </div>

        <div class="glass-panel p-1 rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[70vh]">
            <div class="bg-slate-800/50 p-3 border-b border-white/5">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Oyun Modunu Seç</span>
            </div>
            
            <div class="p-4 space-y-3 overflow-y-auto">
                <!-- AI BUTTON -->
                <button onclick="openAIModal()" class="w-full group relative overflow-hidden p-5 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 border border-indigo-400/30 transition shadow-lg shadow-indigo-500/20">
                    <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition duration-300"></div>
                    <div class="flex items-center relative z-10">
                        <div class="bg-white/20 w-12 h-12 flex items-center justify-center rounded-xl mr-4 text-white shadow-inner"><i class="fas fa-magic text-xl"></i></div>
                        <div class="text-left flex-1">
                            <div class="font-bold text-white text-lg flex items-center gap-2">
                                Yapay Zeka Modu 
                                <span class="bg-white/20 text-[10px] px-2 py-0.5 rounded text-white font-bold">AKTİF</span>
                            </div>
                            <div class="text-xs text-indigo-100 opacity-90">İstediğin konuda özel oyun üret</div>
                        </div>
                        <i class="fas fa-chevron-right text-white/50 group-hover:translate-x-1 transition"></i>
                    </div>
                </button>

                <div class="flex items-center gap-4 my-2 opacity-50">
                    <div class="h-px bg-slate-500 flex-1"></div>
                    <span class="text-[10px] uppercase font-bold text-slate-400">Standart Paketler</span>
                    <div class="h-px bg-slate-500 flex-1"></div>
                </div>

                <button onclick="setCategory('ilkokul')" class="w-full group flex items-center p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">
                    <div class="bg-green-500/20 w-10 h-10 flex items-center justify-center rounded-lg mr-4 text-green-400"><i class="fas fa-shapes"></i></div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-white">İlkokul Düzeyi</div>
                        <div class="text-xs text-slate-400">Hayat Bilgisi, Genel Kültür</div>
                    </div>
                </button>

                <button onclick="setCategory('ortaokul')" class="w-full group flex items-center p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">
                    <div class="bg-blue-500/20 w-10 h-10 flex items-center justify-center rounded-lg mr-4 text-blue-400"><i class="fas fa-atom"></i></div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-white">Ortaokul Düzeyi</div>
                        <div class="text-xs text-slate-400">Fen, Sosyal, Coğrafya</div>
                    </div>
                </button>

                <button onclick="setCategory('lgs')" class="w-full group flex items-center p-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">
                    <div class="bg-purple-500/20 w-10 h-10 flex items-center justify-center rounded-lg mr-4 text-purple-400"><i class="fas fa-brain"></i></div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-white">LGS (8. Sınıf)</div>
                        <div class="text-xs text-slate-400">İnkılap, Türkçe, Fen</div>
                    </div>
                </button>
            </div>
            
            <div class="p-3 bg-slate-800/50 border-t border-white/5">
                 <button onclick="showLeaderboard('all')" class="w-full py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-yellow-400 font-bold text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-trophy"></i> Genel Sıralamayı Gör
                </button>
            </div>
        </div>
    </div>

    <!-- AI KONU SEÇİMİ -->
    <div id="aiModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-md hidden p-4 animate-fade-in">
        <div class="glass-panel p-8 rounded-3xl max-w-sm w-full text-center relative">
            <button onclick="closeAIModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            
            <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30">
                <i class="fas fa-robot text-4xl text-white"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-2">Konunu Belirle</h2>
            <p class="text-slate-400 text-sm mb-6">Yapay zeka, her öğrenci için bu konuda <strong>farklı</strong> şifreler ve sorular hazırlayacak.</p>

            <input type="text" id="aiTopicInput" placeholder="Örn: Uzay, Tarih, Futbol..." class="w-full bg-slate-900/50 border border-slate-600 rounded-xl p-4 text-white mb-4 focus:outline-none focus:border-indigo-500 placeholder-slate-600 text-center font-bold">

            <button onclick="setupAIGame()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-indigo-500/40 transition transform active:scale-95">
                Modu Aktif Et
            </button>
        </div>
    </div>

    <!-- 2. ÖĞRENCİ GİRİŞİ -->
    <div id="loginScreen" class="hidden w-full max-w-md p-6 h-full flex flex-col justify-center items-center fade-in relative">
        <div class="absolute top-6 left-6 z-50 pointer-events-auto">
            <button onclick="goToMainMenu()" class="text-xs font-bold text-slate-300 hover:text-white flex items-center gap-2 bg-slate-700 px-4 py-2 rounded-full border border-slate-600 hover:bg-slate-600 transition shadow-lg cursor-pointer">
                <i class="fas fa-arrow-left"></i> Modu Değiştir
            </button>
        </div>

        <div class="mb-10 text-center mt-12">
            <span id="activeCategoryBadge" class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-500/20 text-indigo-300 text-xs font-bold uppercase tracking-widest border border-indigo-500/30 mb-6 shadow-[0_0_15px_rgba(99,102,241,0.2)]">
                <i class="fas fa-circle text-[6px] animate-pulse"></i> LGS MODU AKTİF
            </span>
            <h1 class="text-4xl md:text-5xl title-font text-white mb-2 drop-shadow-xl">SIRADAKİ?</h1>
            <p class="text-slate-400">İsmini yaz ve sahneye çık.</p>
        </div>
        
        <div class="glass-panel w-full p-8 rounded-3xl relative">
            <div class="absolute -top-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center border-4 border-slate-900 shadow-xl">
                <i class="fas fa-user-astronaut text-3xl text-indigo-400"></i>
            </div>
            
            <div class="mt-6">
                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Öğrenci Adı</label>
                <input type="text" id="studentName" placeholder="Adın Soyadın" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl p-4 text-white text-xl font-bold focus:outline-none focus:border-indigo-500 focus:bg-slate-900 mt-2 text-center placeholder-slate-600 transition-colors" autocomplete="off" onkeypress="handleEnter(event)">
            </div>
            
            <button onclick="startSession()" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-blue-500/30 transition transform hover:translate-y-[-2px] active:scale-95 flex items-center justify-center gap-2">
                BAŞLA <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <!-- 3. OYUN EKRANI -->
    <div id="gameScreen" class="hidden w-full max-w-5xl flex flex-col h-full max-h-screen p-2 md:p-4">
        
        <!-- Üst Bilgi Paneli -->
        <div class="glass-panel p-3 rounded-2xl flex justify-between items-center mb-3 z-20">
            <div class="flex items-center gap-3">
                <button onclick="goToMainMenu()" class="w-10 h-10 rounded-xl bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition flex items-center justify-center" title="Menüye Dön">
                    <i class="fas fa-home"></i>
                </button>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 font-bold uppercase leading-none">Yarışmacı</span>
                    <span id="gamePlayerName" class="text-sm font-bold text-white truncate max-w-[120px]">Öğrenci</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700">
                <div class="flex flex-col items-center">
                    <span class="text-[8px] text-slate-500 font-bold uppercase">Süre</span>
                    <span id="timerDisplay" class="text-blue-400 font-mono font-bold text-lg leading-none">00:00</span>
                </div>
                <div class="h-6 w-px bg-slate-700"></div>
                <div class="flex flex-col items-center">
                    <span class="text-[8px] text-slate-500 font-bold uppercase">Puan</span>
                    <span id="scoreDisplay" class="text-yellow-400 font-mono font-bold text-lg leading-none">0</span>
                </div>
            </div>

            <button onclick="toggleSound()" id="soundBtn" class="w-10 h-10 rounded-xl bg-slate-800 text-slate-400 hover:text-white transition flex items-center justify-center">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>

        <!-- Soru Kartı -->
        <div class="glass-panel rounded-2xl p-6 text-center flex-shrink-0 min-h-[140px] md:min-h-[180px] flex flex-col justify-center relative overflow-hidden mb-3">
            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
            <div class="absolute top-3 right-3 opacity-5"><i class="fas fa-question-circle text-6xl"></i></div>
            
            <span class="inline-block mx-auto bg-indigo-500/20 text-indigo-300 text-[10px] font-bold px-2 py-1 rounded mb-2 border border-indigo-500/20">
                SORU <span id="qIndex">1</span>/6
            </span>
            <h2 id="questionText" class="text-xl md:text-3xl font-bold leading-tight drop-shadow-md px-2 transition-all">Soru Hazırlanıyor...</h2>
        </div>

        <!-- Cevaplar -->
        <div class="flex-1 overflow-y-auto px-1 w-full mb-3">
            <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 pb-2 h-full content-center">
                <!-- Butonlar JS ile -->
            </div>
        </div>

        <!-- Alt Panel: Şifre ve Tahmin -->
        <div class="glass-panel p-4 rounded-2xl flex flex-col md:flex-row items-center gap-4 z-20">
            <div class="flex-1 w-full flex flex-col items-center md:items-start">
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-2 pl-1">GİZLİ ŞİFRE (6 HARF)</span>
                <div id="passwordContainer" class="flex flex-wrap justify-center md:justify-start gap-2">
                    <!-- Harfler JS ile -->
                </div>
            </div>
            
            <button onclick="openGuessModal()" class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold rounded-xl text-sm shadow-lg shadow-orange-500/20 flex items-center justify-center gap-2 transition transform active:scale-95 whitespace-nowrap">
                <i class="fas fa-lightbulb text-yellow-200 animate-pulse"></i> ŞİFREYİ BİLİYORUM
            </button>
        </div>
    </div>

    <!-- TAHMİN ETME MODALI -->
    <div id="guessModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md hidden p-4 fade-in">
        <div class="glass-panel border-2 border-yellow-500/50 p-8 rounded-3xl max-w-sm w-full text-center relative shadow-[0_0_50px_rgba(234,179,8,0.2)]">
            <button onclick="closeGuessModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            
            <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-yellow-400 ring-4 ring-yellow-500/10">
                <i class="fas fa-key text-3xl"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-2">RİSK ALIYOR MUSUN?</h2>
            <p class="text-slate-400 text-xs mb-6 leading-relaxed">
                Şifreyi doğru bilirsen <span class="text-green-400 font-bold">BONUS PUAN</span> kazanırsın.<br>
                Yanlış bilirsen <span class="text-red-400 font-bold">-50 PUAN</span> ceza alırsın!
            </p>

            <input type="text" id="guessInput" placeholder="ŞİFREYİ YAZ" class="w-full bg-slate-900 border-2 border-yellow-600/30 rounded-xl p-4 text-white text-2xl font-bold tracking-[0.2em] text-center focus:outline-none focus:border-yellow-500 uppercase mb-6 placeholder-slate-700" autocomplete="off" maxlength="6">

            <button onclick="checkGuess()" class="w-full py-4 bg-yellow-600 text-white rounded-xl font-bold hover:bg-yellow-500 transition shadow-lg">
                KONTROL ET
            </button>
        </div>
    </div>

    <!-- SONUÇ MODALI -->
    <div id="resultModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md hidden p-4">
        <div class="glass-panel border border-white/10 p-8 rounded-3xl max-w-sm w-full text-center relative overflow-hidden shadow-2xl fade-in">
            <!-- Konfeti Efekti İçin Alan -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 via-blue-500 to-purple-500"></div>
            
            <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg shadow-green-500/30 transform hover:scale-110 transition">
                <i class="fas fa-trophy text-4xl"></i>
            </div>
            
            <h2 class="text-3xl font-black text-white mb-1 tracking-tight">TEBRİKLER!</h2>
            <p class="text-slate-400 text-sm mb-6"><span id="resultPlayerName" class="text-white font-bold text-lg">Ali</span>, harika bir performans!</p>

            <div class="bg-slate-800/50 rounded-2xl p-4 mb-6 grid grid-cols-2 gap-px bg-slate-700 border border-slate-700 overflow-hidden">
                <div class="bg-slate-800 p-2">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Toplam Puan</p>
                    <p id="finalScore" class="text-2xl font-black text-yellow-400">0</p>
                </div>
                <div class="bg-slate-800 p-2">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Süre</p>
                    <p id="finalTime" class="text-2xl font-black text-blue-400">00:00</p>
                </div>
                <div class="col-span-2 bg-slate-800/80 p-3 border-t border-slate-700">
                     <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Çözülen Şifre</p>
                     <p id="finalPassword" class="text-xl font-bold text-white tracking-[0.3em]">BAŞARI</p>
                </div>
            </div>

            <div class="flex gap-3 mb-3">
                 <button onclick="goToMainMenu()" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 hover:text-white transition text-xs flex items-center justify-center gap-2">
                    <i class="fas fa-th-large"></i> Menü
                </button>
                <button onclick="showLeaderboard('current')" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 hover:text-white transition text-xs flex items-center justify-center gap-2">
                    <i class="fas fa-list-ol"></i> Sıralama
                </button>
            </div>
            
            <button onclick="resetForNewStudent()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/25 transition transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-user-plus"></i> Sıradaki Öğrenci
            </button>
        </div>
    </div>

    <!-- LİDERLİK TABLOSU -->
    <div id="leaderboardModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/95 hidden backdrop-blur-md">
        <div class="w-full h-full md:max-w-3xl md:h-[85vh] bg-slate-900 md:glass-panel md:rounded-3xl flex flex-col relative shadow-2xl overflow-hidden">
            
            <div class="p-6 pb-4 border-b border-slate-700/50 bg-slate-900/50">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-black text-white italic tracking-tight"><i class="fas fa-crown text-yellow-500 mr-2"></i> LİDERLER LİGİ</h2>
                        <p class="text-xs text-slate-400 mt-1">Sınıfın en hızlı ve en zeki öğrencileri</p>
                    </div>
                    <button onclick="closeLeaderboard()" class="w-10 h-10 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition text-slate-300">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button onclick="filterLeaderboard('all')" class="lb-filter px-5 py-2 rounded-full bg-blue-600 text-white text-xs font-bold shadow-lg shadow-blue-500/20">Tümü</button>
                    <button onclick="filterLeaderboard('ilkokul')" class="lb-filter px-5 py-2 rounded-full bg-slate-800 text-slate-400 text-xs font-bold hover:bg-slate-700">İlkokul</button>
                    <button onclick="filterLeaderboard('ortaokul')" class="lb-filter px-5 py-2 rounded-full bg-slate-800 text-slate-400 text-xs font-bold hover:bg-slate-700">Ortaokul</button>
                    <button onclick="filterLeaderboard('lgs')" class="lb-filter px-5 py-2 rounded-full bg-slate-800 text-slate-400 text-xs font-bold hover:bg-slate-700">LGS</button>
                    <button onclick="filterLeaderboard('ai')" class="lb-filter px-5 py-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-xs font-bold">Yapay Zeka</button>
                </div>
            </div>

            <div class="grid grid-cols-12 px-6 py-3 text-[10px] font-bold text-slate-500 uppercase bg-slate-900/80 border-b border-slate-800">
                <div class="col-span-1 text-center">#</div>
                <div class="col-span-4 pl-2">Öğrenci</div>
                <div class="col-span-3 text-center">Şifre</div>
                <div class="col-span-2 text-right">Puan</div>
                <div class="col-span-2 text-right">Süre</div>
            </div>

            <div id="leaderboardList" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900/30">
                <!-- JS ile dolacak -->
            </div>
            
            <div class="p-4 text-center border-t border-slate-800 bg-slate-900/50">
                 <button onclick="clearLeaderboard()" class="text-xs text-red-400 hover:text-red-300 opacity-60 hover:opacity-100 transition flex items-center justify-center gap-2 mx-auto">
                    <i class="fas fa-trash-alt"></i> Listeyi Sıfırla
                </button>
            </div>
        </div>
    </div>

    <!-- Yükleniyor Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-brain text-indigo-500 animate-pulse"></i>
            </div>
        </div>
        <p id="loadingText" class="text-indigo-400 font-bold tracking-widest mt-6 animate-pulse text-sm">SİSTEM HAZIRLANIYOR...</p>
    </div>

    <script>
        const apiKey = "AIzaSyBGPjOZ3txt8QM2yM4GSEGIzR4hr2743Nk";

        // --- 6 HARFLİ SABİT ŞİFRE HAVUZU ---
        const passwords = [
            "BAŞARI", "MİLLET", "BAYRAK", "ADALET", "KARDEŞ", "YILDIZ", "KÜLTÜR", "VİCDAN", 
            "DÜRÜST", "SAĞLIK", "EĞİTİM", "ÜRETİM", "KUVVET", "ENERJİ", "MECLİS", "MANTIK", 
            "SİSTEM", "SOSYAL", "CETVEL", "ZEYTİN", "TOPRAK", "RÜZGAR", "ŞİMŞEK", "KARPUZ",
            "KARTAL", "KAPLAN", "DEPREM", "VOLKAN", "OKYANU", "GEZEGE", "MERCEK", "MİKROB"
        ];

        // GENİŞLETİLMİŞ SORU BANKASI
        const questionsDB = {
            ilkokul: [
                {q: "Türkiye'nin başkenti?", a: "Ankara"}, {q: "Bir yılda kaç mevsim var?", a: "4"},
                {q: "29 Ekim'de ne kutlanır?", a: "Cumhuriyet"}, {q: "Alfabenin ilk harfi?", a: "A"},
                {q: "Kırmızı + Beyaz = ?", a: "Pembe"}, {q: "Dünyanın şekli?", a: "Küre"},
                {q: "1 düzine kaçtır?", a: "12"}, {q: "İstiklal Marşı şairi?", a: "M. Akif"},
                {q: "Süt veren hayvan?", a: "İnek"}, {q: "Okuma öğrenilen yer?", a: "Okul"},
                {q: "Haftanın son günü?", a: "Pazar"}, {q: "Bir elin parmak sayısı?", a: "5"},
                {q: "Mavi ile Sarı karışırsa?", a: "Yeşil"}, {q: "Kışın yağan beyaz şey?", a: "Kar"},
                {q: "Arı ne yapar?", a: "Bal"}, {q: "Tavşan ne sever?", a: "Havuç"},
                {q: "En büyük kara hayvanı?", a: "Fil"}, {q: "Denizler ne renktir?", a: "Mavi"},
                {q: "Ağaçta yetişen kırmızı meyve?", a: "Elma"}, {q: "Muz hangi renktir?", a: "Sarı"},
                {q: "Okulda ders anlatan kişi?", a: "Öğretmen"}, {q: "Diş fırçasına ne sürülür?", a: "Macun"},
                {q: "Gece gökyüzünde parlayan?", a: "Yıldız"}, {q: "Türkiye'nin kurucusu?", a: "Atatürk"},
                {q: "Bir deste kaçtır?", a: "10"}, {q: "Trafik ışığında Dur rengi?", a: "Kırmızı"},
                {q: "Koyun yavrusuna ne denir?", a: "Kuzu"}, {q: "Yazın hava nasıl olur?", a: "Sıcak"},
                {q: "Burun ne işe yarar?", a: "Koku"}, {q: "Göz ne işe yarar?", a: "Görme"},
                {q: "Postacı ne getirir?", a: "Mektup"}, {q: "Futbol neyle oynanır?", a: "Top"},
                {q: "Hangi taşıt havada gider?", a: "Uçak"}, {q: "Balık nerede yaşar?", a: "Su"},
                {q: "Saat neyi gösterir?", a: "Zaman"}, {q: "Kare şeklinin kaç kenarı var?", a: "4"},
                {q: "Limonun tadı nasıldır?", a: "Ekşi"}, {q: "Hangisi bir mevsimdir?", a: "Yaz"}
            ],
            ortaokul: [
                {q: "Suyun formülü?", a: "H2O"}, {q: "İstanbul'un Fethi?", a: "1453"},
                {q: "Maddenin en sıcak hali?", a: "Plazma"}, {q: "En yüksek dağımız?", a: "Ağrı"},
                {q: "Işığı geçirmeyen?", a: "Opak"}, {q: "Elma (İngilizce)?", a: "Apple"},
                {q: "Üçgen iç açıları?", a: "180"}, {q: "Pusulada Kuzey?", a: "N"},
                {q: "En büyük gezegen?", a: "Jüpiter"}, {q: "Akdeniz bitki örtüsü?", a: "Maki"},
                {q: "Yer kabuğu bilimi?", a: "Jeoloji"}, {q: "Atatürk'ün şehri?", a: "Selanik"},
                {q: "Atomun merkezi?", a: "Çekirdek"}, {q: "Kuvvet birimi?", a: "Newton"},
                {q: "Ayın yuvarlak hali?", a: "Dolunay"}, {q: "Türkiye'nin güneyi?", a: "Akdeniz"},
                {q: "Sıvı ölçü birimi?", a: "Litre"}, {q: "Kanı pompalayan organ?", a: "Kalp"},
                {q: "Solunum organımız?", a: "Akciğer"}, {q: "Dinamometre ne ölçer?", a: "Kuvvet"},
                {q: "İlk Türk hükümdar?", a: "Kağan"}, {q: "Malazgirt Savaşı?", a: "1071"},
                {q: "Çöl iklimi bitkisi?", a: "Kaktüs"}, {q: "Dünyanın uydusu?", a: "Ay"},
                {q: "En hızlı koşan hayvan?", a: "Çita"}, {q: "İpek Yolu başlangıcı?", a: "Çin"},
                {q: "Futbol maçı kaç dk?", a: "90"}, {q: "Telefonu kim icat etti?", a: "Bell"},
                {q: "Ampulü kim buldu?", a: "Edison"}, {q: "Yerçekimini kim buldu?", a: "Newton"},
                {q: "Mıknatıs neyi çeker?", a: "Demir"}, {q: "Isı birimi nedir?", a: "Joule"},
                {q: "Hücrenin enerji santrali?", a: "Mitokondri"}, {q: "Türkiye'nin başkenti?", a: "Ankara"}
            ],
            lgs: [
                {q: "DNA yapı birimi?", a: "Nükleotid"}, {q: "Fiilimsi sayısı?", a: "3"},
                {q: "Mustafa Kemal rütbesi?", a: "Mareşal"}, {q: "8A grubu elementleri?", a: "Soygaz"},
                {q: "Karekök 144?", a: "12"}, {q: "Basınç birimi?", a: "Pascal"},
                {q: "Hücre yönetimi?", a: "Çekirdek"}, {q: "Sivas Kongresi kararı?", a: "Ulusal"},
                {q: "Asit yağmuru gazı?", a: "SO2"}, {q: "İsim fiil eki?", a: "Ma-ış-mak"},
                {q: "Mevsimlerin nedeni?", a: "Eksen Eğikliği"}, {q: "Milli Mücadele başı?", a: "Samsun"},
                {q: "Dik üçgen bağıntısı?", a: "Pisagor"}, {q: "Isı alan katı?", a: "Erime"},
                {q: "Doğu Cephesi komutanı?", a: "Kazım K."}, {q: "Periyodik tablo?", a: "Mendeleyev"},
                {q: "Lozan Antlaşması yılı?", a: "1923"}, {q: "TBMM açılışı?", a: "1920"},
                {q: "Kalıtımın babası?", a: "Mendel"}, {q: "Asitlerin tadı?", a: "Ekşi"},
                {q: "Bazların tadı?", a: "Acı"}, {q: "pH 7 nedir?", a: "Nötr"},
                {q: "Katı basıncı nedeni?", a: "Ağırlık"}, {q: "Sıvı basıncı nedeni?", a: "Derinlik"},
                {q: "Amasya Genelgesi?", a: "İhtilal"}, {q: "İlk anayasa?", a: "1921"},
                {q: "Tekalifi Milliye?", a: "Sakarya"}, {q: "Medeni Kanun yılı?", a: "1926"},
                {q: "Sıfat fiil eki?", a: "An-a-sı-mez"}, {q: "Zarf fiil eki?", a: "Ken-yalı"},
                {q: "DNA eşlenmesi ne zaman?", a: "Bölünme Öncesi"}, {q: "Hangi renk ışık sıcak?", a: "Kırmızı"},
                {q: "Periyodik tabloda yatay sıra?", a: "Periyot"}, {q: "Metal ile ametal bağı?", a: "İyonik"}
            ]
        };

        const distractors = ["5", "Hayır", "Mars", "Paris", "O2", "Karbon", "6", "İzmir", "Güney", "Sıfat", "Hücre", "Atom", "Elips", "Litre", "Newton", "Gaz", "Sıvı", "10", "100", "Lozan", "Sevr", "Mondros", "Asya", "Avrupa", "Yeşil", "Turuncu", "4", "8", "Fizik", "Kimya", "Biyoloji", "Zamiri", "Yüklem", "Özne", "Hız", "İvme"];

        // --- GLOBAL DEĞİŞKENLER ---
        let currentLevel = "ilkokul";
        let currentAITopic = ""; 
        let currentPlayer = "";
        let gameData = [];
        let currentPassword = "";
        let step = 0;
        let score = 0;
        let startTime = 0;
        let timerInterval = null;
        let soundEnabled = true;
        let aiGeneratedData = null;
        let usedQuestions = { ilkokul: [], ortaokul: [], lgs: [] }; 

        // --- GEMINI API ---
        async function fetchAIQuestions(topic) {
            const loadingText = document.getElementById('loadingText');
            loadingText.innerText = "YAPAY ZEKA ŞİFRE ÜRETİYOR...";
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const randomSeed = Math.floor(Math.random() * 10000); 
            
            const aiRequestPrompt = `
                Sen bir öğretmensin. Konu: "${topic}".
                Görev: Bu konuyla ilgili TAM OLARAK 6 HARFLİ bir şifre (kelime) belirle ve 6 adet çoktan seçmeli soru hazırla.
                ÖNEMLİ: Her seferinde FARKLI bir şifre seçmeye çalış. (Seed: ${randomSeed})
                
                Kurallar:
                1. Şifre KESİNLİKLE 6 harfli olmalı (Örn: EĞİTİM, KARTAL).
                2. Her soru için 7 tane YANLIŞ cevap (çeldirici) üret.
                3. Çıktı SADECE geçerli bir JSON objesi olmalı.

                JSON Formatı:
                {
                    "password": "ALTIHR", 
                    "questions": [
                        { "q": "Soru 1?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] },
                        { "q": "Soru 2?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] },
                        { "q": "Soru 3?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] },
                        { "q": "Soru 4?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] },
                        { "q": "Soru 5?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] },
                        { "q": "Soru 6?", "a": "Doğru", "d": ["Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7"] }
                    ]
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: aiRequestPrompt }] }] })
                });

                if (!response.ok) throw new Error("API Hatası: " + response.status);

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                // JSON Temizleme
                const jsonStartIndex = text.indexOf('{');
                const jsonEndIndex = text.lastIndexOf('}');
                if (jsonStartIndex !== -1 && jsonEndIndex !== -1) {
                    text = text.substring(jsonStartIndex, jsonEndIndex + 1);
                }
                
                const jsonResult = JSON.parse(text);
                aiGeneratedData = jsonResult;
                return true;

            } catch (error) {
                console.error("Hata:", error);
                alert("Yapay zeka şu an meşgul. Lütfen tekrar dene.");
                document.getElementById('loadingOverlay').classList.add('hidden');
                return false;
            }
        }

        // --- UI KONTROLLERİ ---
        function openAIModal() { document.getElementById('aiModal').classList.remove('hidden'); document.getElementById('aiTopicInput').focus(); }
        function closeAIModal() { document.getElementById('aiModal').classList.add('hidden'); }
        function openGuessModal() { document.getElementById('guessModal').classList.remove('hidden'); document.getElementById('guessInput').value = ""; document.getElementById('guessInput').focus(); }
        function closeGuessModal() { document.getElementById('guessModal').classList.add('hidden'); }

        function handleEnter(e) {
            if(e.key === 'Enter') startSession();
        }

        function setupAIGame() {
            const topic = document.getElementById('aiTopicInput').value.trim();
            if (topic.length < 2) { alert("Lütfen bir konu girin."); return; }
            currentAITopic = topic; 
            closeAIModal();
            
            currentLevel = 'ai';
            document.getElementById('activeCategoryBadge').innerHTML = `<i class="fas fa-robot mr-1"></i> KONU: ${topic.toUpperCase()}`;
            document.getElementById('activeCategoryBadge').className = "inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-cyan-500/20 text-cyan-300 text-xs font-bold uppercase tracking-widest border border-cyan-500/30 mb-6 shadow-[0_0_15px_rgba(34,211,238,0.2)]";
            
            document.getElementById('categoryScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('studentName').value = "";
            setTimeout(() => document.getElementById('studentName').focus(), 500);
        }

        function goToMainMenu() {
            if(confirm("Ana menüye dönmek istediğine emin misin?")) {
                stopTimer();
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('resultModal').classList.add('hidden');
                document.getElementById('categoryScreen').classList.remove('hidden');
                usedQuestions = { ilkokul: [], ortaokul: [], lgs: [] };
            }
        }

        function setCategory(level) {
            currentLevel = level;
            aiGeneratedData = null;
            let badgeText = level === 'lgs' ? "LGS MODU" : (level === 'ilkokul' ? "İLKOKUL MODU" : "ORTAOKUL MODU");
            document.getElementById('activeCategoryBadge').innerHTML = `<i class="fas fa-layer-group mr-1"></i> ${badgeText}`;
            document.getElementById('activeCategoryBadge').className = `inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-500/20 text-indigo-300 text-xs font-bold uppercase tracking-widest border border-indigo-500/30 mb-6 shadow-[0_0_15px_rgba(99,102,241,0.2)]`;

            document.getElementById('categoryScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('studentName').value = "";
            setTimeout(() => document.getElementById('studentName').focus(), 500);
        }

        async function startSession() {
            const input = document.getElementById('studentName');
            const name = input.value.trim();
            if(name.length < 2) { shakeElement(input); return; }
            
            currentPlayer = name;
            document.getElementById('gamePlayerName').innerText = currentPlayer;
            document.getElementById('loginScreen').classList.add('hidden');
            
            try {
                if (currentLevel === 'ai') {
                    // Yapay Zeka Modu - Her seferinde yeni üretim
                    const success = await fetchAIQuestions(currentAITopic);
                    if (!success) {
                        document.getElementById('loginScreen').classList.remove('hidden');
                        return;
                    }
                } else {
                    // Standart Mod - Gecikmeli Başlatma
                    document.getElementById('loadingText').innerText = "SORULAR SEÇİLİYOR...";
                    document.getElementById('loadingOverlay').classList.remove('hidden');
                    await new Promise(r => setTimeout(r, 800)); 
                }
                initGame();
            } catch (e) {
                console.error(e);
                alert("Oyun başlatılamadı. Lütfen tekrar deneyin.");
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        function shakeElement(el) {
            el.classList.add('shake', 'border-red-500');
            setTimeout(() => el.classList.remove('shake', 'border-red-500'), 500);
        }

        function initGame() {
            if (currentLevel === 'ai' && aiGeneratedData) {
                currentPassword = aiGeneratedData.password.toUpperCase();
                gameData = aiGeneratedData.questions.map((q, i) => ({
                    q: q.q, a: q.a, d: q.d || distractors, char: currentPassword[i] || '?'
                }));
            } else {
                currentPassword = passwords[Math.floor(Math.random() * passwords.length)];
                generateUniqueStandardQuestions(currentLevel, 6);
            }
            
            step = 0; score = 0; 
            updateScoreDisplay(); 
            renderPasswordBox();
            
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            nextQuestion(); 
            startTimer();
        }

        function generateUniqueStandardQuestions(level, count) {
            gameData = [];
            let pool = questionsDB[level];
            let used = usedQuestions[level];
            
            // Eğer havuz bitmek üzereyse sıfırla
            if (!pool || pool.length - used.length < count) {
                usedQuestions[level] = [];
                used = [];
            }
            
            // Kullanılmamış soruları bul
            let availableQuestions = pool.filter(q => !used.includes(q.q));
            
            for (let i = 0; i < count; i++) {
                if (availableQuestions.length === 0) {
                    availableQuestions = pool; // Yedek plan: tekrar havuzdan çek
                }
                
                const randIdx = Math.floor(Math.random() * availableQuestions.length);
                const q = availableQuestions[randIdx];
                
                usedQuestions[level].push(q.q); // Kullanıldı işaretle
                
                gameData.push({ 
                    q: q.q, a: q.a, 
                    char: currentPassword[i] 
                });
                
                availableQuestions.splice(randIdx, 1);
            }
        }

        function renderPasswordBox() {
            const container = document.getElementById('passwordContainer');
            container.innerHTML = '';
            for (let i = 0; i < currentPassword.length; i++) {
                container.innerHTML += `
                    <div class="char-box w-10 h-14 md:w-12 md:h-16 relative select-none" id="char-${i}">
                        <div class="char-inner">
                            <div class="char-front text-slate-500 font-bold text-xl flex items-center justify-center border border-slate-600 rounded-xl bg-slate-800">?</div>
                            <div class="char-back text-2xl md:text-3xl flex items-center justify-center rounded-xl">${currentPassword[i]}</div>
                        </div>
                    </div>`;
            }
        }

        function nextQuestion() {
            if (step >= gameData.length) { endGame(); return; }
            const data = gameData[step];
            document.getElementById('qIndex').innerText = step + 1;
            
            const qText = document.getElementById('questionText');
            qText.style.opacity = 0; qText.style.transform = "translateY(10px)";
            
            setTimeout(() => {
                qText.innerText = data.q; 
                qText.style.opacity = 1; 
                qText.style.transform = "translateY(0)";
            }, 200);

            let options = [data.a];
            let wrongs = [];
            
            if (data.d && Array.isArray(data.d) && data.d.length >= 7) {
                wrongs = data.d; 
            } else {
                const allAnswers = questionsDB[currentLevel] ? questionsDB[currentLevel].map(x => x.a).concat(distractors) : distractors;
                wrongs = allAnswers.filter(a => a !== data.a);
            }
            
            let safeWrongs = [...wrongs];
            while (options.length < 8 && safeWrongs.length > 0) {
                const randIndex = Math.floor(Math.random() * safeWrongs.length);
                const w = safeWrongs[randIndex];
                if (!options.includes(w)) options.push(w);
                if(options.length < 8 && safeWrongs.every(x => options.includes(x))) break;
            }
            
            options.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('answersGrid');
            grid.innerHTML = '';
            grid.className = "grid grid-cols-2 md:grid-cols-4 gap-3 h-full content-center";

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "answer-btn w-full h-12 md:h-16 rounded-xl font-bold text-xs md:text-sm shadow-sm break-words px-2 hover:brightness-95 flex items-center justify-center text-center leading-tight";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(btn, opt, data.a);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(btn, selected, correct) {
            if (btn.disabled) return;
            if (selected === correct) {
                playSound('correct'); 
                btn.classList.add('correct'); 
                btn.innerHTML = '<i class="fas fa-check text-2xl"></i>';
                document.getElementById(`char-${step}`).classList.add('revealed');
                score += 100; step++;
                document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
                updateScoreDisplay(); 
                setTimeout(nextQuestion, 800);
            } else {
                playSound('error'); 
                btn.classList.add('wrong', 'shake');
                score = Math.max(0, score - 20);
                updateScoreDisplay(); 
                setTimeout(() => btn.classList.remove('shake', 'wrong'), 500);
            }
        }

        function checkGuess() {
            const input = document.getElementById('guessInput');
            const userGuess = input.value.trim().toLocaleUpperCase('tr-TR');
            const actualPassword = currentPassword.toLocaleUpperCase('tr-TR');

            if (userGuess === actualPassword) {
                playSound('correct');
                closeGuessModal();
                for(let i=0; i<currentPassword.length; i++) {
                    document.getElementById(`char-${i}`).classList.add('revealed');
                }
                const remainingQuestions = gameData.length - step;
                const bonus = remainingQuestions * 200;
                score += bonus;
                updateScoreDisplay();
                setTimeout(endGame, 1000);
            } else {
                playSound('error');
                score = Math.max(0, score - 50);
                updateScoreDisplay();
                input.classList.add('shake', 'border-red-500');
                input.value = "YANLIŞ!";
                setTimeout(() => {
                    input.classList.remove('shake', 'border-red-500');
                    input.value = "";
                    input.focus();
                }, 1000);
            }
        }

        function startTimer() {
            startTime = Date.now(); clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); return Math.floor((Date.now() - startTime) / 1000); }
        function updateScoreDisplay() {
            const el = document.getElementById('scoreDisplay');
            el.innerText = score; el.classList.add('scale-125', 'text-white');
            setTimeout(() => el.classList.remove('scale-125', 'text-white'), 200);
        }

        function endGame() {
            const duration = stopTimer();
            const timeBonus = Math.max(0, (90 - duration) * 2);
            const totalScore = score + timeBonus;

            document.getElementById('resultPlayerName').innerText = currentPlayer;
            document.getElementById('finalScore').innerText = totalScore;
            
            const m = Math.floor(duration / 60).toString().padStart(2, '0');
            const s = (duration % 60).toString().padStart(2, '0');
            document.getElementById('finalTime').innerText = `${m}:${s}`;
            document.getElementById('finalPassword').innerText = currentPassword;

            saveScore({ name: currentPlayer, score: totalScore, time: duration, level: currentLevel, password: currentPassword });
            playSound('win'); fireConfetti();
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function resetForNewStudent() {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('studentName').value = "";
            document.getElementById('studentName').focus();
        }

        function saveScore(data) {
            let scores = JSON.parse(localStorage.getItem('sifre_ustasi_pro_v1') || '[]');
            scores.push(data);
            localStorage.setItem('sifre_ustasi_pro_v1', JSON.stringify(scores));
        }
        function showLeaderboard(filter) {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            if(filter === 'current') filter = currentLevel;
            filterLeaderboard(filter);
        }
        function closeLeaderboard() { document.getElementById('leaderboardModal').classList.add('hidden'); }
        function filterLeaderboard(filter) {
            document.querySelectorAll('.lb-filter').forEach(btn => {
                const isActive = btn.innerText.toLowerCase().includes(filter === 'all' ? 'tümü' : (filter === 'ai' ? 'yapay' : filter));
                btn.className = isActive 
                    ? "lb-filter px-5 py-2 rounded-full bg-blue-600 text-white text-xs font-bold shadow-lg scale-105 transition"
                    : "lb-filter px-5 py-2 rounded-full bg-slate-800 text-slate-400 text-xs font-bold hover:bg-slate-700 transition";
            });
            const list = document.getElementById('leaderboardList'); list.innerHTML = '';
            let scores = JSON.parse(localStorage.getItem('sifre_ustasi_pro_v1') || '[]');
            if (filter !== 'all') scores = scores.filter(s => s.level === filter);
            scores.sort((a, b) => { if (b.score !== a.score) return b.score - a.score; return a.time - b.time; });
            if (scores.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 py-10">Bu kategoride henüz kayıt yok.</div>'; return; }
            scores.forEach((s, index) => {
                const m = Math.floor(s.time / 60).toString().padStart(2, '0');
                const sec = (s.time % 60).toString().padStart(2, '0');
                const isTop = index === 0;
                const div = document.createElement('div');
                div.className = `grid grid-cols-12 px-6 py-4 rounded-xl items-center text-sm mb-2 transition hover:bg-slate-800 ${isTop ? 'bg-gradient-to-r from-yellow-500/10 to-transparent border border-yellow-500/20' : 'bg-slate-900 border border-slate-800'}`;
                div.innerHTML = `
                    <div class="col-span-1 text-center font-black ${isTop ? 'text-yellow-400 text-xl' : 'text-slate-500'}">${index + 1}</div>
                    <div class="col-span-4 pl-2 font-bold text-white truncate flex items-center gap-2">
                        ${isTop ? '<i class="fas fa-crown text-yellow-500 animate-bounce"></i>' : ''} ${s.name}
                    </div>
                    <div class="col-span-3 text-center font-mono text-xs text-indigo-400 tracking-widest">${s.password || '---'}</div>
                    <div class="col-span-2 text-right font-black text-yellow-400">${s.score}</div>
                    <div class="col-span-2 text-right font-mono text-slate-400 text-xs">${m}:${sec}</div>
                `;
                list.appendChild(div);
            });
        }
        function clearLeaderboard() {
            if(confirm("Tüm sınıfın skorları silinecek. Emin misin?")) {
                localStorage.removeItem('sifre_ustasi_pro_v1'); filterLeaderboard('all');
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'win') {
                [523, 659, 784, 1046].forEach((f, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination); o.type='square'; o.frequency.value=f;
                    g.gain.setValueAtTime(0.05, now+i*0.1); g.gain.linearRampToValueAtTime(0, now+i*0.1+0.2);
                    o.start(now+i*0.1); o.stop(now+i*0.1+0.2);
                });
            }
        }
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundBtn').className = soundEnabled ? "w-10 h-10 rounded-xl bg-slate-800 text-slate-400 hover:text-white transition flex items-center justify-center" : "w-10 h-10 rounded-xl bg-slate-800 text-red-500 transition flex items-center justify-center"; }
        function fireConfetti() {
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899'];
            for (let i = 0; i < 150; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.style.left = Math.random()*100+'vw'; c.style.top = -10+'px';
                c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                c.style.animation = `fall ${Math.random()*3+2}s linear forwards`;
                c.style.transform = `rotate(${Math.random()*360}deg)`;
                document.body.appendChild(c); setTimeout(() => c.remove(), 5000);
            }
            const s = document.createElement('style'); s.innerHTML = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`; document.head.appendChild(s);
        }
    </script>
</body>
</html>


